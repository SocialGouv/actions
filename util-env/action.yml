name: "Setup env"
description: "Setup env vars"
inputs:
  rancherId:
    description: "The Rancher project ID, usually secrets.RANCHER_PROJECT_ID"
  rancherProjectName:
    description: "The Rancher project name, usually secrets.RANCHER_PROJECT_NAME, usefull jobs that needs secrets or ci namespaces"
  environment:
    description: "The deployment environment (dev | preprod | prod)"
    default: dev
  baseNamespace:
    description: "Override base namespace"
  
runs:
  using: "composite"
  steps:
    - name: Setup env vars
      shell: bash
      run: |
        ENVIRONMENT=${{ inputs.environment || env.ENVIRONMENT }}
        REPOSITORY_NAME=${GITHUB_REPOSITORY##*/}
        
        if [ -n "$GITHUB_HEAD_REF" ]; then
          BRANCH_NAME=$GITHUB_HEAD_REF
        else
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          BRANCH_NAME=${BRANCH_NAME#refs/tags/}
        fi

        BRANCH_SLUG=$(npx @socialgouv/env-slug ${BRANCH_NAME})
        RANCHER_PROJECT_ID=${{ inputs.rancherId || env.RANCHER_PROJECT_ID }}
        RANCHER_PROJECT_NAME=${{ inputs.rancherProjectName || env.RANCHER_PROJECT_NAME }}
        if [ -n "${{ inputs.baseNamespace }}" ]; then
          BASE_NAMESPACE="${{ inputs.baseNamespace }}"
        else
          BASE_NAMESPACE=$REPOSITORY_NAME
        fi
        if [ "$ENVIRONMENT" = "prod" ]; then
          NAMESPACE=$BASE_NAMESPACE
        elif [ "$ENVIRONMENT" = "preprod" ]; then
          NAMESPACE=${BASE_NAMESPACE}-preprod
        else
          NAMESPACE=$(npx @socialgouv/env-slug "${BASE_NAMESPACE}-${BRANCH_NAME}")
        fi
        JOB_NAMESPACE=${RANCHER_PROJECT_NAME:-"$REPOSITORY_NAME"}-ci
        SECRETS_NAMESPACE="${RANCHER_PROJECT_NAME:-"$REPOSITORY_NAME"}-secret"

        AUTODEVOPS_PATH=/tmp/autodevops
        mkdir -p $AUTODEVOPS_PATH

        # general purpose env vars
        echo "ENVIRONMENT=$ENVIRONMENT" >> $GITHUB_ENV
        echo "REPOSITORY_NAME=$REPOSITORY_NAME" >> $GITHUB_ENV
        echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
        echo "BRANCH_SLUG=$BRANCH_SLUG" >> $GITHUB_ENV
        echo "NAMESPACE=$NAMESPACE" >> $GITHUB_ENV
        echo "RANCHER_PROJECT_ID=$RANCHER_PROJECT_ID" >> $GITHUB_ENV
        echo "RANCHER_PROJECT_NAME=$RANCHER_PROJECT_NAME" >> $GITHUB_ENV
        echo "JOB_NAMESPACE=$JOB_NAMESPACE" >> $GITHUB_ENV
        echo "SECRETS_NAMESPACE=$SECRETS_NAMESPACE" >> $GITHUB_ENV
        echo "AUTODEVOPS_PATH=$AUTODEVOPS_PATH" >> $GITHUB_ENV