name: "⛑ Generate manifests ⛑"
description: "Generate k8s manifests via kosko-charts autodevops"
inputs:
  environment:
    description: "The deployment envirnoment (dev | preprod | prod)"
outputs:
  json:
    description: "Json debug"
    value: ${{ steps.debug-manifests.outputs.json }}
  markdown:
    description: "Markdown debug"
    value: ${{ steps.debug-manifests.outputs.markdown }}
  text:
    description: "Text debug"
    value: ${{ steps.debug-manifests.outputs.text }}

runs:
  using: "composite"
  steps:

    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Load preproduction environment variables
      run: |
        cat ".github/preproduction.env" >> $GITHUB_ENV

    - name: Yarn cache setup
      uses: c-hive/gha-yarn-cache@v1

    - name: Install kosko-charts autodevops
      run: |
        npx degit SocialGouv/kosko-charts/templates/autodevops /tmp/autodevops
        yarn --cwd /tmp/autodevops

    - name: Copy application k8s config to autodevops
      run: cp -r .socialgouv/environments .socialgouv/config.json /tmp/autodevops/

    - name: Generate k8s manifests
      run: |
        echo SOCIALGOUV_BASE_DOMAIN: $SOCIALGOUV_BASE_DOMAIN
        yarn --cwd /tmp/autodevops --silent generate --env ${ENVIRONMENT} > manifests.yml
      env:
        SOCIALGOUV_PREPRODUCTION: true
        ENVIRONMENT: ${{ inputs.environment }}
        SOCIALGOUV_CONFIG_PATH: /tmp/autodevops/config.json
        SOCIALGOUV_BASE_DOMAIN: ${{ env.SOCIALGOUV_BASE_DOMAIN }}

    - name: Archive k8s manifests
      uses: actions/upload-artifact@v2
      with:
        name: manifests.yml
        path: manifests.yml
